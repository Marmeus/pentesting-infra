#!/bin/bash
sudo rm -rf Nginx PiHole PwnDoc Gitea docker-compose.yml

cp docker-compose-bkp.yml docker-compose.yml

if [ "$#" -lt 1 ]; then
    echo "Usage: $0 '<PIHOLE_PASS>'"
    exit 1
fi

# PiHole
sed -i "s/<PIHOLE_PASSWD>/$1/g" docker-compose.yml
HOST_IP=$(ip -br a | grep -i eth0 | awk '{print $3}' | cut -d '/' -f 1)
mkdir -p ./PiHole/etc-pihole/
echo "$HOST_IP dns.lan" > PiHole/etc-pihole/custom.list
echo "$HOST_IP git.lan" >> PiHole/etc-pihole/custom.list
echo "$HOST_IP pwndoc.lan" >> PiHole/etc-pihole/custom.list
echo "$HOST_IP netdata.lan" >> PiHole/etc-pihole/custom.list



# Gitea
mkdir -p ./Gitea/{data,config,backup}
sudo chown 1000:1000 ./Gitea/{config/,data/,backup/}

# PwnDoc
git clone https://github.com/pwndoc/pwndoc PwnDoc
cp docker-compose-pwndoc.yml ./PwnDoc/docker-compose.yml

# Nginx
mkdir -p ./Nginx/{conf.d,ssl}
cp default.conf ./Nginx/conf.d/default.conf
cd ./Nginx/ssl && openssl req -x509 -nodes -days 36500 -newkey rsa:2048 -keyout nginx-selfsigned.key -out nginx-selfsigned.crt
cd -

# Execute
docker compose up -d
